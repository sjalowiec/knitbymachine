<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ask 'n Answer Catalogue | Knit by Machine</title>
  <meta name="description" content="Browse all our knitting machine questions and answers, organized by topic. Find solutions to troubleshooting, techniques, machines, and more.">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #f3f7ec;
      color: #333;
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }

    /* Main Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    /* White Background Section */
    .catalog-wrapper {
      background-color: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(82, 104, 45, 0.08);
    }

    header {
      display: flex;
      align-items: center;
      gap: 2rem;
      margin-bottom: 3rem;
      padding-bottom: 2rem;
      border-bottom: 2px solid #52682D;
    }

    .ana-logo {
      width: 180px;
      height: 180px;
      flex-shrink: 0;
    }

    .subtitle {
      color: #52682D;
      font-size: 2rem;
      font-weight: 600;
      line-height: 1.3;
      flex: 1;
      text-align: center;
    }

    .controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 3rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-wrapper {
      flex: 1;
      min-width: 250px;
      max-width: 500px;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 1.25rem;
      border: 2px solid #c7d8a4;
      border-radius: 50px;
      font-size: 1rem;
      background-color: white;
      transition: border-color 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: #52682D;
    }

    .sort-wrapper {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .sort-label {
      color: #52682D;
      font-weight: 500;
    }

    .sort-select {
      padding: 0.75rem 1rem;
      border: 2px solid #c7d8a4;
      border-radius: 50px;
      font-size: 1rem;
      background-color: white;
      cursor: pointer;
      transition: border-color 0.3s;
    }

    .sort-select:focus {
      outline: none;
      border-color: #52682D;
    }

    .category-section {
      margin-bottom: 3rem;
      transition: opacity 0.3s;
    }

    .category-section.hidden {
      display: none;
    }

    .category-header {
      color: #52682D;
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    /* Row wrapper with arrows on sides */
    .row-wrapper {
      display: flex;
      align-items: center;
      gap: 1rem;
      position: relative;
    }

    /* ===== SCROLLING CONTAINER - Enhanced with smooth scrolling and snap ===== */
    .scrollable-row {
      flex: 1;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: #c7d8a4 transparent;
      padding: 0.5rem 1rem 1rem 1rem;
      scroll-behavior: smooth;
      scroll-snap-type: x mandatory;
      cursor: grab;
    }

    .scrollable-row:active {
      cursor: grabbing;
    }

    .scrollable-row::-webkit-scrollbar {
      height: 6px;
    }

    .scrollable-row::-webkit-scrollbar-track {
      background: transparent;
    }

    .scrollable-row::-webkit-scrollbar-thumb {
      background-color: #c7d8a4;
      border-radius: 10px;
    }

    .bubbles-container {
      display: flex;
      gap: 1rem;
      padding: 0.5rem;
      min-width: min-content;
    }

    /* ===== SCROLL NAVIGATION ARROWS ===== */
    .scroll-arrow {
      width: 44px;
      height: 44px;
      min-width: 44px;
      border-radius: 50%;
      background-color: #c7d8a4;
      border: 2px solid #52682D;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.25s ease-in-out;
      box-shadow: 0 2px 8px rgba(82, 104, 45, 0.15);
      flex-shrink: 0;
    }

    .scroll-arrow:hover {
      background-color: #52682D;
      transform: scale(1.08);
      box-shadow: 0 4px 12px rgba(82, 104, 45, 0.25);
    }

    .scroll-arrow svg {
      width: 22px;
      height: 22px;
      fill: #52682D;
      transition: fill 0.25s ease-in-out;
    }

    .scroll-arrow:hover svg {
      fill: white;
    }

    .scroll-arrow.hidden {
      opacity: 0.3;
      pointer-events: none;
    }

    /* ===== THOUGHT BUBBLES - Enhanced with scroll-snap and improved hover ===== */
    .thought-bubble {
      position: relative;
      background-color: #ffffff;
      color: #52682D;
      border: 1px solid #c7d8a4;
      padding: 1.25rem 1.75rem;
      border-radius: 25px;
      text-decoration: none;
      font-size: 1.1rem;
      font-weight: 500;
      white-space: normal;
      max-width: 280px;
      min-width: 180px;
      transition: all 0.25s ease-in-out;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      cursor: pointer;
      flex-shrink: 0;
      margin-left: 24px;
      scroll-snap-align: start;
      word-wrap: break-word;
      hyphens: auto;
    }

    .thought-bubble::before {
      content: '';
      position: absolute;
      left: -14px;
      bottom: 20px;
      width: 12px;
      height: 12px;
      background-color: #ffffff;
      border: 1px solid #c7d8a4;
      border-radius: 50%;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      transition: all 0.25s ease-in-out;
    }

    .thought-bubble::after {
      content: '';
      position: absolute;
      left: -24px;
      bottom: 12px;
      width: 8px;
      height: 8px;
      background-color: #ffffff;
      border: 1px solid #c7d8a4;
      border-radius: 50%;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      transition: all 0.25s ease-in-out;
    }

    .thought-bubble:hover {
      background-color: #eef4e5;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.12);
    }

    .thought-bubble:hover::before,
    .thought-bubble:hover::after {
      background-color: #eef4e5;
    }

    .thought-bubble.hidden {
      display: none;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: #52682D;
      font-size: 1.2rem;
    }

    .error {
      text-align: center;
      padding: 3rem;
      color: #d64545;
      background-color: #ffe5e5;
      border-radius: 10px;
      margin: 2rem;
    }

    .no-results {
      text-align: center;
      padding: 3rem;
      color: #666;
      font-style: italic;
    }

    @media (max-width: 768px) {
      header {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
      }

      .ana-logo {
        width: 120px;
        height: 120px;
      }

      .subtitle {
        font-size: 1.25rem;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .search-wrapper,
      .sort-wrapper {
        width: 100%;
      }

      .sort-wrapper {
        justify-content: space-between;
      }

      .thought-bubble {
        font-size: 1rem;
        padding: 1rem 1.5rem;
        max-width: 240px;
      }

      .catalog-wrapper {
        margin: 1rem;
        padding: 1.5rem;
      }

      .site-header nav {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Header Placeholder -->
  <div id="header-placeholder"></div>

  <div class="container">
    <div class="catalog-wrapper">
      <header>
        <img src="https://knitbymachine.com/assets/icons/asknanswer-icon.svg" alt="Ask 'n Answer" class="ana-logo">
        <p class="subtitle">Troubleshoot, learn, and master your knitting machine -<br>one question at a time.</p>
      </header>

      <div class="controls">
        <div class="search-wrapper">
          <input 
            type="text" 
            class="search-input" 
            id="searchInput" 
            placeholder="Search ANA questions..."
            aria-label="Search questions"
          >
        </div>
        <div class="sort-wrapper">
          <label for="sortSelect" class="sort-label">Sort by:</label>
          <select id="sortSelect" class="sort-select" aria-label="Sort order">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="alphabetical">Alphabetical</option>
          </select>
        </div>
      </div>

      <div id="catalogueContent" class="loading">
        Loading ANA questions...
      </div>
    </div>
  </div>

  <!-- Footer Placeholder -->
  <div id="footer-placeholder"></div>

  <script>
    let allEntries = [];
    let currentSort = 'newest';

    async function fetchANAEntries() {
      try {
        const response = await fetch('https://api.github.com/repos/sjalowiec/knitbymachine/contents/src/content/ana');
        
        if (!response.ok) {
          throw new Error(`GitHub API error: ${response.status}`);
        }

        const files = await response.json();
        
        // Fetch each JSON file's content
        const entries = await Promise.all(
          files
            .filter(file => file.name.endsWith('.json'))
            .map(async (file) => {
              const fileResponse = await fetch(file.download_url);
              const data = await fileResponse.json();
              return {
                title: data.title,
                slug: data.slug,
                category: data.category || 'Uncategorized',
                tags: data.tags || [],
                isDraft: data.isDraft,
                pendingPublish: data.pendingPublish,
                publishedDate: data.publishedDate,
              };
            })
        );

        // Filter out drafts and pending items
        return entries.filter(entry => !entry.isDraft && !entry.pendingPublish);
      } catch (error) {
        console.error('Error fetching ANA entries:', error);
        throw error;
      }
    }

    function sortEntries(entries, sortBy) {
      const sorted = [...entries];
      
      switch(sortBy) {
        case 'newest':
          sorted.sort((a, b) => {
            const dateA = a.publishedDate ? new Date(a.publishedDate) : new Date(0);
            const dateB = b.publishedDate ? new Date(b.publishedDate) : new Date(0);
            return dateB - dateA;
          });
          break;
        case 'oldest':
          sorted.sort((a, b) => {
            const dateA = a.publishedDate ? new Date(a.publishedDate) : new Date(0);
            const dateB = b.publishedDate ? new Date(b.publishedDate) : new Date(0);
            return dateA - dateB;
          });
          break;
        case 'alphabetical':
          sorted.sort((a, b) => a.title.localeCompare(b.title));
          break;
      }
      
      return sorted;
    }

    function groupByCategory(entries) {
      const grouped = {};
      entries.forEach(entry => {
        if (!grouped[entry.category]) {
          grouped[entry.category] = [];
        }
        grouped[entry.category].push(entry);
      });
      return grouped;
    }

    function renderCatalogue(entries) {
      const container = document.getElementById('catalogueContent');
      const sortedEntries = sortEntries(entries, currentSort);
      const grouped = groupByCategory(sortedEntries);
      const categories = Object.keys(grouped).sort();

      if (categories.length === 0) {
        container.innerHTML = '<div class="no-results">No questions found matching your search.</div>';
        return;
      }

      let html = '';

      categories.forEach(category => {
        const categoryEntries = grouped[category];

        html += `
          <div class="category-section" data-category="${category}">
            <h2 class="category-header">${category}</h2>
            <div class="row-wrapper">
              <button class="scroll-arrow left" aria-label="Scroll left">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                  <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
              </button>
              <div class="scrollable-row" data-row-id="${category.replace(/\s+/g, '-').toLowerCase()}">
                <div class="bubbles-container">
                ${categoryEntries.map(entry => `
                  <a 
                    href="https://knitbymachine.com/ana/${entry.slug}" 
                    class="thought-bubble" 
                    data-title="${entry.title.toLowerCase()}"
                    data-tags="${(entry.tags || []).join(' ').toLowerCase()}"
                  >
                    ${entry.title}
                  </a>
                `).join('')}
                </div>
              </div>
              <button class="scroll-arrow right" aria-label="Scroll right">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                  <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                </svg>
              </button>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function filterCatalogue(searchTerm) {
      const term = searchTerm.toLowerCase().trim();
      const sections = document.querySelectorAll('.category-section');

      sections.forEach(section => {
        const bubbles = section.querySelectorAll('.thought-bubble');
        let hasVisibleBubbles = false;

        bubbles.forEach(bubble => {
          const title = bubble.dataset.title;
          const tags = bubble.dataset.tags;
          const matches = title.includes(term) || tags.includes(term);

          if (matches) {
            bubble.classList.remove('hidden');
            hasVisibleBubbles = true;
          } else {
            bubble.classList.add('hidden');
          }
        });

        if (hasVisibleBubbles) {
          section.classList.remove('hidden');
        } else {
          section.classList.add('hidden');
        }
      });
      
      // Update arrow visibility after filtering
      setTimeout(() => {
        document.querySelectorAll('.scrollable-row').forEach(row => {
          const rowWrapper = row.closest('.row-wrapper');
          if (!rowWrapper) return;
          
          const leftArrow = rowWrapper.querySelector('.scroll-arrow.left');
          const rightArrow = rowWrapper.querySelector('.scroll-arrow.right');
          
          if (leftArrow && rightArrow) {
            const isAtStart = row.scrollLeft <= 0;
            const isAtEnd = row.scrollLeft >= row.scrollWidth - row.clientWidth - 1;
            
            leftArrow.classList.toggle('hidden', isAtStart);
            rightArrow.classList.toggle('hidden', isAtEnd);
          }
        });
      }, 50);
    }

    /* ===== SCROLLING ENHANCEMENTS - Drag-to-scroll and arrow navigation ===== */
    function initializeScrollingEnhancements() {
      const scrollableRows = document.querySelectorAll('.scrollable-row');
      
      scrollableRows.forEach(row => {
        // Drag-to-scroll functionality
        let isDown = false;
        let startX;
        let scrollLeft;
        
        row.addEventListener('mousedown', (e) => {
          // Don't interfere with links
          if (e.target.closest('.thought-bubble')) return;
          
          isDown = true;
          startX = e.pageX - row.offsetLeft;
          scrollLeft = row.scrollLeft;
        });
        
        row.addEventListener('mouseleave', () => {
          isDown = false;
        });
        
        row.addEventListener('mouseup', () => {
          isDown = false;
        });
        
        row.addEventListener('mousemove', (e) => {
          if (!isDown) return;
          e.preventDefault();
          const x = e.pageX - row.offsetLeft;
          const walk = (x - startX) * 2;
          row.scrollLeft = scrollLeft - walk;
        });
        
        // Arrow button navigation - find arrows in parent row-wrapper
        const rowWrapper = row.closest('.row-wrapper');
        if (!rowWrapper) return;
        
        const leftArrow = rowWrapper.querySelector('.scroll-arrow.left');
        const rightArrow = rowWrapper.querySelector('.scroll-arrow.right');
        
        if (leftArrow) {
          leftArrow.addEventListener('click', () => {
            row.scrollBy({ left: -300, behavior: 'smooth' });
          });
        }
        
        if (rightArrow) {
          rightArrow.addEventListener('click', () => {
            row.scrollBy({ left: 300, behavior: 'smooth' });
          });
        }
        
        // Update arrow visibility based on scroll position
        function updateArrowVisibility() {
          const isAtStart = row.scrollLeft <= 0;
          const isAtEnd = row.scrollLeft >= row.scrollWidth - row.clientWidth - 1;
          
          if (leftArrow) leftArrow.classList.toggle('hidden', isAtStart);
          if (rightArrow) rightArrow.classList.toggle('hidden', isAtEnd);
        }
        
        row.addEventListener('scroll', updateArrowVisibility);
        updateArrowVisibility(); // Initial check
      });
    }

    // Load shared header and footer
    async function loadHeaderFooter() {
      try {
        // Load header
        const headerResponse = await fetch("https://kbm-global.netlify.app/header.html");
        const headerData = await headerResponse.text();
        document.getElementById("header-placeholder").innerHTML = headerData;
      } catch (error) {
        console.error('Error loading header:', error);
      }

      try {
        // Load footer
        const footerResponse = await fetch("https://kbm-global.netlify.app/footer.html");
        const footerData = await footerResponse.text();
        document.getElementById("footer-placeholder").innerHTML = footerData;
      } catch (error) {
        console.error('Error loading footer:', error);
      }
    }

    // Initialize
    async function init() {
      // Load header and footer
      loadHeaderFooter();
      
      try {
        allEntries = await fetchANAEntries();
        renderCatalogue(allEntries);
        // Initialize scrolling enhancements after rendering
        setTimeout(initializeScrollingEnhancements, 100);
      } catch (error) {
        document.getElementById('catalogueContent').innerHTML = `
          <div class="error">
            <p><strong>Error loading questions</strong></p>
            <p>Unable to fetch ANA entries from GitHub. Please try again later.</p>
            <p style="font-size: 0.9rem; margin-top: 1rem;">${error.message}</p>
          </div>
        `;
      }
    }

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', (e) => {
      filterCatalogue(e.target.value);
    });

    document.getElementById('sortSelect').addEventListener('change', (e) => {
      currentSort = e.target.value;
      renderCatalogue(allEntries);
      // Re-apply search filter if exists
      const searchTerm = document.getElementById('searchInput').value;
      if (searchTerm) {
        filterCatalogue(searchTerm);
      }
      // Reinitialize scrolling after re-render
      setTimeout(initializeScrollingEnhancements, 100);
    });

    // Start the app
    init();
  </script>
</body>
</html>
